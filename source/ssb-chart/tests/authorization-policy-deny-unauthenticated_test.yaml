# The authorization-policy.yaml actually includes minimu 2, maximum 4 yamls in one file so to be able to check all the tag documentindex must be used

# This file tests the deny unauthenticated part of the istio-authentication.yaml template.

suite: test authorzation-policy-deny-unauthenticated
templates:
  - authorization-policy.yaml
tests:
  
  - it: should render nothing if not enabled
    values: 
      - ./values/default-values.yaml
    set:
      appType: frontend
    asserts:
      - hasDocuments:
          count: 0
          
  - it: should render two documents if enabled
    values: 
      - ./values/default-values.yaml
    asserts:
      - hasDocuments:
          count: 2

  - it: should include default labels and name in deny-unauthenticated
    values: 
       - ./values/authorization-policy-values.yaml
    release:
      name: unittest-app-release
      namespace: unittesting
    documentIndex: 3
    asserts:
      - equal:
          path: metadata.labels
          value: 
            app: unittest-app
            billing-project: ssb-unittest
            chart: ssb-chart-1.3.1
            heritage: Tiller
            release: unittest-app-release
      - equal:
          path: metadata.name
          value: unittest-app-deny-auth-policy
      - isKind:
          of: AuthorizationPolicy

  - it: should render DENY action and specified paths in deny-unauthenticated
    values: 
       - ./values/authorization-policy-values.yaml
    release:
      name: unittest-app-release
      namespace: unittesting
    documentIndex: 3
    asserts:
      - equal:
          path: spec.selector.matchLabels.app
          value: unittest-app
      - equal:
          path: spec.action
          value: DENY
      - equal:
          path: spec.rules
          value: 
            - from:
              - source:
                  notRequestPrincipals:
                  - '*'
              to:
              - operation:
                  paths:
                  - /auth
                  - /auth/
                  - /auth/*
