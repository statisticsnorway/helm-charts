# The authorization-policy.yaml actually includes minimu 2, maximum 4 yamls in one file so to be able to check all the tag documentindex must be used

# This file tests the allow-health part of the istio-authentication.yaml template

suite: test authorzation-policy-allow-health
templates:
  - authorization-policy.yaml
tests:
  
  - it: should render nothing if not enabled
    values: 
      - ./values/default-values.yaml
    set:
      appType: frontend
    asserts:
      - hasDocuments:
          count: 0
          
  - it: should render two documents if enabled
    values: 
      - ./values/default-values.yaml
    asserts:
      - hasDocuments:
          count: 2

  - it: should include default labels and name in allow-metrics-auth-policy
    values: 
       - ./values/authorization-policy-values.yaml
    release:
      name: unittest-app-release
      namespace: unittesting
    documentIndex: 1
    asserts:
      - equal:
          path: metadata.labels
          value: 
            app: unittest-app
            billing-project: ssb-unittest
            chart: ssb-chart-2.1.0
            heritage: Tiller
            release: unittest-app-release
      - equal:
          path: metadata.name
          value: unittest-app-allow-health-auth-policy
      - isKind:
          of: AuthorizationPolicy

  - it: should render name, ALLOW action and metrics path in allow-metrics-auth-policy
    values: 
       - ./values/authorization-policy-values.yaml
    release:
      name: unittest-app-release
      namespace: unittesting
    documentIndex: 1
    asserts:
      - equal:
          path: spec.selector.matchLabels.app
          value: unittest-app
      - equal:
          path: spec.action
          value: ALLOW
      - equal: 
          path: spec.rules
          value:
            - to:
              - operation:
                  paths:
                  - /healthz/ready
