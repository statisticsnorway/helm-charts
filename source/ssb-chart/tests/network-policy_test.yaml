suite: test network-policy
templates:
  - network-policy.yaml
tests:
  
  - it: should render nothing if not enabled
    set: 
      networkpolicy.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render one document if enabled
    values:
     - ./values/network-policy-default-values.yaml
    release:
      name: unittest-app-release
      namespace: unittesting
    asserts: 
      - hasDocuments:
          count: 1

  
  - it: should include default labels and be of kind NetworkPolicy
    values:
      - ./values/network-policy-default-values.yaml
    release:
      name: unittest-app-release
      namespace: unittesting
    asserts:
      - equal: 
          path: metadata.labels
          value:
            app: unittest-app
            billing-project: ssb-unittest
            chart: ssb-chart-2.0.0
            heritage: Tiller
            release: unittest-app-release
      - isKind:
          of: NetworkPolicy    
  
  # Assert that "default" metrics np is rendered, i.e the Istio metrics port
  - it: should allow Prometheus scraping on Istio-proxy metrics port if not overridden
    values:
     - ./values/network-policy-default-values.yaml
    release:
      name: unittest-app-release
      namespace: unittesting
    asserts: 
      - equal:
          path: spec.ingress
          value:
            - from:
              - namespaceSelector:
                  matchLabels:
                    name: monitoring
                podSelector:
                  matchLabels:
                    app: prometheus
                    component: server
              ports:
              - port: 15090
                protocol: TCP
            - from:
              - namespaceSelector: {}
              ports:
              - port: 80
                protocol: TCP
  
  # Assert that, in addition to a np to Istio proxy metrics port, the apps
  # metrics port gets a np
  - it: should allow Prometheus scraping on Istio-proxy metrics port and application metrics port
    values:
     - ./values/network-policy-metrics-enabled-values.yaml
    release:
      name: unittest-app-release
      namespace: unittesting
    asserts: 
      - equal:
          path: spec.ingress
          value:
            - from:
              - namespaceSelector:
                  matchLabels:
                    name: monitoring
                podSelector:
                  matchLabels:
                    app: prometheus
                    component: server
              ports:
              - port: 15090
                protocol: TCP
            - from:
              - namespaceSelector: {}
              ports:
              - port: 80
                protocol: TCP
            - from:
              - namespaceSelector:
                  matchLabels:
                    name: monitoring
                podSelector:
                  matchLabels:
                    app: prometheus
                    component: server
              ports:
              - port: 80
                protocol: TCP
  # Assert that correct result are created if the HR specifies the whole network policy
  - it: should render the policy defined in values
    values:
     - ./values/network-policy-override-default-policy-values.yaml
    release:
      name: unittest-app-release
      namespace: unittesting
    asserts: 
      - equal:
          path: spec
          value:
            egress:
            - ports:
              - port: 53
                protocol: UDP
              - port: 53
                protocol: TCP
              to:
              - namespaceSelector: {}
                podSelector:
                  matchLabels:
                    k8s-app: kube-dns
            enabled: true
            ingress:
            - from:
              - namespaceSelector: {}
              ports:
              - port: 80
                protocol: TCP
            podSelector:
              matchLabels:
                app: unittest-app
