# Tests the istio-app-to-app authorization policies. This should render 0,1 or 2 policies
# depending on configuration

suite: test authorzation-policy-app-to-app-allow-metrics
templates:
  - istio-app-to-app-auth.yaml
tests:
# Render nothing if not enabled (enabled=false by default)
  - it: should render nothing if not enabled
    values:
      - ./values/default-values.yaml
    set:
      appType: frontend
    asserts:
      - hasDocuments:
          count: 0


# If enabled and service accounts specified a policy with the service accounts should be created
  - it: should render name, ALLOW action and service accounts in the app-to-app policy
    values:
      - ./values/istio-authorization-app-to-app-values.yaml
    set:
      istioAppToAppAuth.from:
        - serviceAccount: cluster.local/ns/cumulus/sa/unittest-app-b-sa
        - serviceAccount: cluster.local/ns/cumulus/sa/unittest-app-c-sa
    release:
      name: unittest-app-release
      namespace: unittesting
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: spec.selector.matchLabels.app
          value: unittest-app
      - equal:
          path: spec.action
          value: ALLOW


  - it: should render name, ALLOW action and service accounts in the app-to-app policy, one instance check
    values:
      - ./values/istio-authorization-app-to-app-values.yaml
    set:
      istioAppToAppAuth.from:
        - serviceAccount: cluster.local/ns/cumulus/sa/unittest-app-b-sa
        - serviceAccount: cluster.local/ns/cumulus/sa/unittest-app-c-sa
    release:
      name: unittest-app-release
      namespace: unittesting
    documentIndex: 0
    asserts:
      - equal:
          path: spec.selector.matchLabels.app
          value: unittest-app
      - equal:
          path: spec.action
          value: ALLOW
      - equal:
          path: spec.rules
          value:
            - from:
              - source:
                  principals:
                    - cluster.local/ns/cumulus/sa/unittest-app-b-sa


# If enabled and service accounts specified a policy with the service accounts should be created
  - it: should render name, ALLOW action and namespace appName in the app-to-app policy
    values:
      - ./values/istio-authorization-app-to-app-values.yaml
    set:
      istioAppToAppAuth.from:
        - namespace: cumulus
          appName: unittest-app-c
    release:
      name: unittest-app-release
      namespace: unittesting
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.selector.matchLabels.app
          value: unittest-app
      - equal:
          path: spec.action
          value: ALLOW
      - equal:
          path: spec.rules
          value:
            - from:
                - source:
                    principals:
                      - cluster.local/ns/cumulus/sa/unittest-app-c-sa

  - it: should render name, ALLOW action and service accounts and namespace&appname in the app-to-app policy
    values:
      - ./values/istio-authorization-app-to-app-values.yaml
    set:
      istioAppToAppAuth.from:
        - serviceAccount: cluster.local/ns/cumulus/sa/unittest-app-b-sa
        - serviceAccount: cluster.local/ns/cumulus/sa/unittest-app-c-sa
        - namespace: cumulus
          appName: unittest-app-c
    release:
      name: unittest-app-release
      namespace: unittesting
    asserts:
      - hasDocuments:
          count: 3
      - equal:
          path: spec.selector.matchLabels.app
          value: unittest-app
      - equal:
          path: spec.action
          value: ALLOW