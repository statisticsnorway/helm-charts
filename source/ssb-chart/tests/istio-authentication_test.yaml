suite: test istio authentication
templates:
  - istio-authentication.yaml
tests:
  
  - it: should render nothing if not enabled
    set: 
      networkpolicy.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render two documents if enabled
    values:
     - ./values/istio-authentication-values.yaml
    release:
      name: unittest-app-release
      namespace: unittesting
    asserts: 
      - hasDocuments:
          count: 2
  
  - it: first document should be of kind RequestAuthentication, have correct name and include default labels
    values:
     - ./values/istio-authentication-values.yaml
    release:
      name: unittest-app-release
      namespace: unittesting
    documentIndex: 0
    asserts: 
      - isKind:
          of: RequestAuthentication
      - equal:
          path: metadata.name
          value: unittest-app-request-auth
      - equal:
          path: metadata.labels
          value: 
            app: unittest-app
            billing-project: ssb-unittest
            chart: ssb-chart-1.3.1
            heritage: Tiller
            release: unittest-app-release

  - it: second document should be of kind AuthorizationPolicy, have correct name and include default labels
    values:
     - ./values/istio-authentication-values.yaml
    release:
      name: unittest-app-release
      namespace: unittesting
    documentIndex: 1
    asserts: 
      - isKind:
          of: AuthorizationPolicy
      - equal:
          path: metadata.name
          value: unittest-app-default-auth-policy
      - equal:
          path: metadata.labels
          value: 
            app: unittest-app
            billing-project: ssb-unittest
            chart: ssb-chart-1.3.1
            heritage: Tiller
            release: unittest-app-release
  
  - it: RequestAuthentication should have match labels on app-name, have Keycloak as the issuer, forwardOriginaltoken and audience should only be the unittest-app (default)
    values:
     - ./values/istio-authentication-values.yaml
    release:
      name: unittest-app-release
      namespace: unittesting
    documentIndex: 0
    asserts: 
      - equal:
          path: spec.selector.matchLabels.app
          value: unittest-app
      - equal:
          path: spec.jwtRules
          value:
            - audiences:
              - unittest-app
              forwardOriginalToken: true
              issuer: https://keycloak.test-cluster.ssb.no/auth/realms/ssb

  - it: RequestAuthentication should have match labels on app-name, have Keycloak as the issuer, forwardOriginaltoken and audience should be the audience the audience specified in values
    values:
     - ./values/istio-authentication-with-audience-values.yaml
    release:
      name: unittest-app-release
      namespace: unittesting
    documentIndex: 0
    asserts: 
      - equal:
          path: spec.selector.matchLabels.app
          value: unittest-app
      - equal:
          path: spec.jwtRules
          value:
            - audiences:
              - unittest-frontend-application
              - unittest-another-frontend-application
              forwardOriginalToken: true
              issuer: https://keycloak.test-cluster.ssb.no/auth/realms/ssb

  - it: AuthorizationPolicy should ALLOW any principal (iss/sub) that is authenticated with (issuer) in the RequestAuthentication
    values:
     - ./values/istio-authentication-values.yaml
    release:
      name: unittest-app-release
      namespace: unittesting
    documentIndex: 1
    asserts: 
      - equal:
          path: spec.action
          value: ALLOW
      - equal:
          path: spec.rules
          value:
            - from:
              - source:
                  requestPrincipals:
                  - '*'
